<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymer-unit-prefix/polymer-unit-prefix.html">

<dom-module id="unit-convert">
  <template>
    <unit-prefix 
      from="{{from}}" 
      value="{{value}}"
      result="{{normalizedValue}}">
    </unit-prefix>
  </template>
</dom-module>
<script>

  var unitMap = {

    "meter": {
      "yard": 1 / 0.9144,
      "mile": 1 / 0.9144 / 1760,
    }

  };

  var unitPrefixElement = document.createElement('unit-prefix');
  
  Polymer({

    is: 'unit-convert',

    properties: {
      from: {
        type: String,
        notify: true
      },
      to: {
        type: String,
        notify: true
      },
      value: {
        type: Number,
        notify: true
      },
      normalizedValue: {
        type: Number,
        notify: true,
        value: null
      },
      result: {
        type: Number,
        readOnly: true
      }
    },

    ready: function() {
      this.addEventListener('from-changed', this.update);
      this.addEventListener('to-changed', this.update);
      this.addEventListener('normalized-value-changed', this.update);
      this.update();
    },

    update: function() {

      if(!areDefined([this.from, this.to, this.normalizedValue])) {
        this._setResult(null);
        return;
      }

      this._setResult(this.calculate());

    },

    calculate: function(from, to, value) {

      if(value) {
        //debugger;
      }

      from = from || this.from;
      to = to || this.to;
      value = value || this.normalizedValue;

      if(areDefined([ from, to, value ])) {
        var mapping = this.getUnitMapping(from, to);
        return value * mapping;
      }

      return undefined;

    },

    getBaseUnit: function(unit) {
      return unitPrefixElement.getBaseUnit(unit);
    },

    baseUnitMatches: function(baseUnit, unit) {

      if(baseUnit === unit) {
        return true
      } else if (baseUnit.length === unit.length) {
        return false;
      } else if(unit.indexOf(baseUnit) !== -1) {
        return (unit.indexOf(baseUnit) + baseUnit.length) === unit.length;
      }

      return false;

    },

    getUnitMapping: function(fromUnit, toUnit) {

      var fromBaseUnit = this.getBaseUnit(fromUnit),
          toBaseUnit = this.getBaseUnit(toUnit);

      if(fromBaseUnit === toBaseUnit) {
        return 1;
      }

      var i,j;
      for(i in unitMap) {
        if(unitMap.hasOwnProperty(i)) {

          console.log(i);
          for(j in unitMap[i]) {
            if(unitMap[i].hasOwnProperty(j)) {

              console.log(i, j);

              if((j === fromBaseUnit) && (i === toBaseUnit)) {
                return 1 / unitMap[i][j];
              } else if((i === fromBaseUnit) && (j === toBaseUnit)) {
                return unitMap[i][j];
              }

            }
          }

        }
      }
      
    }

  });

  function areDefined (arr) {

    var self = this,
        allValuesAreDefined = true;

    arr.forEach(function(value) {
      if(!isDefined(value)) {
        allValuesAreDefined = false;
      }
    });

    return allValuesAreDefined;

  }

  function isDefined (value) {
    return (value !== undefined) && (value !== null);
  }

</script>
